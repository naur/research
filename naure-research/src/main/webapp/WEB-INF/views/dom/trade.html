<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link href="http://cdn.naure.org/css/default.css" rel="stylesheet" type="text/css"/>
    <link href="http://cdn.naure.org/css/naure.message.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="http://cdn.naure.org/js/core/require.js"></script>
    <script type="text/javascript" src=""></script>
    <script>
        require.config({
            paths: {
                'jquery': 'http://code.jquery.com/jquery-2.1.0.min',
                'jquery.strings': 'http://cdn.naure.org/js/core/jquery.strings',
                'oop': 'http://cdn.naure.org/js/core/oop',
                'naure': 'http://cdn.naure.org/js/core/naure',
                'naure.utility': 'http://cdn.naure.org/js/core/naure.utility',
                'naure.message': 'http://cdn.naure.org/js/core/naure.message',
                'naure.http.xmlhttp': 'http://cdn.naure.org/js/core/naure.http.xmlhttp'
            },
            shim: {
                'jquery.strings': ['jquery']
            }
        });

        //Open	High	Low	Close	Volume, EPS
        var global = {
            http: null, message: null, isShow: false, clock: null, interval: 10000, totalAmount: 0, currAmount: 0,
            stocks: [
                ['*ST景谷', 2200, 16104.37, '600265', 'sh'],
                ['*ST华塑', 2500, 9949.81, '000509', 'sz'],
                ['天伦置业', 1500, 9969.86, '000711', 'sz'],
                ['金宇车城', 1000, 8320.75, '000803', 'sz'],
                ['德棉股份', 2100, 15239.01, '002072', 'sz'],
                ['凯撒股份', 600, 6375.90, '002425', 'sz', 9.24]
            ],
            stockHtmlTemplate: '<tr class="{7}" stock="{4}{3}" number="{1}" cost="{2}" amount="{5}" curr="{6}"><td class="name">{0}</td><td class="number">{1}</td><td class="cost">{2}</td>' +
                    '<td class="curr"></td><td class="profits"></td><td class="profitability"></td><td class="code">{3}</td>' +
                    '<td class="amount">{5}</td><td class="latest-value"></td><td></td><td></td>' +
                    '<td></td><td></td><td></td><td></td>' +
                    '<td></td><td></td><td></td><td></td>' +
                    '</tr>',
            stockUri: 'http://hq.sinajs.cn/list=',
            messageTemplate: 'clock: {0}, cost: {1}, curr: {2}, {3}, {4} {5}',
            dom: {
                message: '#message',
                stocksContainer: '#stocks tbody',
                stocksHead: '#stocks thead tr',
                stocksName: '#stocks thead tr td:first-child, #stocks tbody tr td:first-child',
                stocks: '#stocks tbody tr'
            }
        };

        function getStockInfo(codes, refresh) {
            global.http.request({uri: global.stockUri + codes.toString(),
                success: function (obj) {
                    eval(obj.output.replace(/var hq_str_/g, 'global.'));

                    global.currAmount = 0;
                    var stockRealtime, startDom, curr, parent, cost, number, amount;
                    for (var index in codes) {
                        stockRealtime = global[codes[index]].split(',');
                        parent = $(global.dom.stocks + '[stock="' + codes[index] + '"]');
                        startDom = parent.find('.curr');// $(global.dom.stocks + '[stock="' + codes[index] + '"] .curr');
                        cost = parseFloat(parent.attr('cost'));
                        number = parseFloat(parent.attr('number'));
                        amount = parseFloat(parent.attr('amount'));
                        curr = parseFloat(parent.attr('curr')) == 0 ? stockRealtime[3] : parseFloat(parent.attr('curr'));
                        global.currAmount += number * curr;
                        startDom.html(curr).
                                next().html((curr * number - amount).toFixed(2)).
                                next().html(((curr * number - amount) / amount * 100).toFixed(2)).
                                next().next().next().html((curr * number).toFixed(2)).
                                next().html(stockRealtime[2]).
                                next().html(stockRealtime[1]).
                                next().html(stockRealtime[4]).
                                next().html(stockRealtime[5]).
                                next().html(stockRealtime[11]).
                                next().html(stockRealtime[10]).
                                next().html(stockRealtime[13]).
                                next().html(stockRealtime[12]).
                                next().html((stockRealtime[8] / 100).toFixed()).
                                next().html((stockRealtime[9] / 10000).toFixed(2));
                    }
                    global.message.show({content: $.format(global.messageTemplate, global.clock, global.totalAmount, global.currAmount, (global.currAmount - global.totalAmount).toFixed(2), stockRealtime[stockRealtime.length - 3], stockRealtime[stockRealtime.length - 2])});
                    if (!refresh) global.clock = setTimeout('getStockInfo(global.stocks.codes)', global.interval);
                }, error: function (err) {
                    delete err.http;
                    global.message.show({content: $.format(global.messageTemplate, global.clock, global.totalAmount, global.currAmount, (global.currAmount - global.totalAmount).toFixed(2), JSON.stringify(err))});
                    if (!refresh) global.clock = setTimeout('getStockInfo(global.stocks.codes)', global.interval);
                }, changed: function (obj) {
                    //window.console.log(JSON.stringify({clock: global.clock, state: obj.state}));
                }});
        }

        function init(stocks) {
            var codes = [];
            var html = '';
            for (var index in stocks) {
                if (!stocks.hasOwnProperty(index)) continue;
                global.totalAmount += stocks[index][2];
                html += $.format(global.stockHtmlTemplate,
                        stocks[index][0], stocks[index][1],
                        (stocks[index][2] / stocks[index][1]).toFixed(3), stocks[index][3],
                        stocks[index][4], stocks[index][2].toFixed(2),
                        stocks[index][5] ? stocks[index][5] : 0, index % 2 == 0 ? '' : 'tdeven');
                codes.push(stocks[index][4] + stocks[index][3]);
            }
            stocks.html = html;
            stocks.codes = codes;
        }

        require(['jquery', 'jquery.strings', 'naure.http.xmlhttp', 'naure.message'], function ($, $1, NAURE) {
            global.http = NAURE.HTTP;
            global.message = NAURE.Message;
            $('body').message({overlay: 'left-bottom', multiple: false, title: ''});
            init(global.stocks);
            $(function () {
                $(global.dom.stocksContainer).html(global.stocks.html);
                $(document).on('keyup', function (event) {
                    var ev = document.all ? window.event : event;
                    if (ev.keyCode == 82)  getStockInfo(global.stocks.codes, true);
                    if (ev.keyCode == 72) {
                        'none' == $(global.dom.stocksHead).css('display') ?
                                $(global.dom.stocksHead).css('display', 'table-row') :
                                $(global.dom.stocksHead).css('display', 'none');
                    }
                    if (ev.keyCode == 78) {
                        'none' == $(global.dom.stocksName).css('display') ?
                                $(global.dom.stocksName).css('display', 'table-cell') :
                                $(global.dom.stocksName).css('display', 'none');
                    }
                });

                global.clock = setTimeout('getStockInfo(global.stocks.codes)', 5000);
            });
        });
    </script>
    <style>
        thead tr, tbody tr td:first-child {
            display: none;
        }

        table tbody tr {
            text-align: right;
        }

        table tbody tr td:first-child {
            text-align: center;
        }
    </style>
</head>
<body style="background-color: #ffffff;">
<table id="stocks" rules="rows">
    <colgroup align="right" style="color:#0000FF;"></colgroup>
    <thead>
    <tr>
        <th class="name">证券名称</th>
        <th class="number">证券数量</th>
        <th class="cost">成本价</th>
        <th class="curr">当前价</th>
        <th class="profits">浮动盈亏</th>
        <th class="profitability">盈亏比例(%)</th>
        <th class="code">证券代码</th>
        <th class="amount">成本金额</th>
        <th class="latest-value">最新市值</th>
        <th>昨日收盘价</th>
        <th>今日开盘价</th>
        <th>今日最高价</th>
        <th>今日最低价</th>
        <th>竞买价</th>
        <th>竞买价</th>
        <th>竞卖价</th>
        <th>竞卖价</th>
        <th>成交量</th>
        <th>成交额</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
</body>
</html>
