<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link href="http://cdn.naure.org/css/default.css" rel="stylesheet" type="text/css"/>
    <link href="http://cdn.naure.org/css/naure.message.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="http://cdn.naure.org/js/core/require.js"></script>
    <script type="text/javascript" src=""></script>
    <script>
        require.config({
            paths: {
                'jquery': 'http://code.jquery.com/jquery-2.1.0.min',
                'jquery.strings': 'http://cdn.naure.org/js/core/jquery.strings',
                'oop': 'http://cdn.naure.org/js/core/oop',
                'naure': 'http://cdn.naure.org/js/core/naure',
                'naure.utility': 'http://cdn.naure.org/js/core/naure.utility',
                'naure.message': 'http://cdn.naure.org/js/core/naure.message',
                'naure.http.xmlhttp': 'http://cdn.naure.org/js/core/naure.http.xmlhttp'
            },
            shim: {
                'jquery.strings': ['jquery']
            }
        });

        //Open	High	Low	Close	Volume, EPS
        var global = {
            http: null, message: null, isShow: false, clock: null, interval: 10000, totalAmount: 0, currAmount: 0,
            stocks: [
                ['*ST景谷', 2200, 16104.37, '600265', 'sh', 9.05],
                ['*ST华塑', 2500, 9949.81, '000509', 'sz'],
                ['天伦置业', 1500, 9969.86, '000711', 'sz'],
                ['金宇车城', 1000, 8320.75, '000803', 'sz'],
                ['德棉股份', 2100, 15239.01, '002072', 'sz'],
                ['凯撒股份', 600, 6375.90, '002425', 'sz', 9.24]
            ],
            stockHtmlTemplate: '<tr class="{7}" stock="{0}{1}" number="{2}" cost="{3}" amount="{4}" curr="{5}">' +
                    '<td class="name">{6}</td><td class="code">{1}</td><td class="number">{2}</td><td class="cost">{3}</td>' +
                    '<td class="curr"></td><td class="profits"></td><td class="profitability"></td>' +
                    '<td class="amount">{4}</td><td class="latest-value"></td><td class="totalcapital"></td><td class="currcapital"></td>' +
                    '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>' +
                    '</tr>',
            stockUri: {
                sina: {uri: 'http://hq.sinajs.cn/list=', parse: function (codes, info) {
                    eval(info.replace(/var hq_str_/g, 'global.'));
                    var stock, stocks = {};
                    for (var index in codes) {
                        stock = global[codes[index]].split(',');
                        stocks[codes[index]] = {};
                        stocks[codes[index]].curr = stock[3];
                        stocks[codes[index]].yclose = stock[2];
                        stocks[codes[index]].open = stock[1];
                        stocks[codes[index]].high = stock[4];
                        stocks[codes[index]].low = stock[5];
                    }

                    return stocks;
                }},
                tencent: {uri: 'http://qt.gtimg.cn/q=', parse: function () {
                }}
            },
            currStockUri: 'sina',
            messageTemplate: 'clock: {0}, cost: {1}, curr: {2}, {3}, {4} {5}',
            dom: {
                message: '#message',
                stocksContainer: '#stocks tbody',
                stocksHead: '#stocks thead tr',
                stocksName: '#stocks thead tr td:first-child, #stocks tbody tr td:first-child',
                stocks: '#stocks tbody tr'
            }
        };

        function getStockInfo(codes, refresh) {
            global.http.request({uri: global.stockUri[global.currStockUri].uri + codes.toString(),
                success: function (obj) {
                    //TODO
                    var stocks = global.stockUri[global.currStockUri].parse(codes, obj.output);

                    global.currAmount = 0;
                    var stockRealtime, startDom, curr, parent, cost, number, amount;
                    for (var index in codes) {
                        stockRealtime = stocks[codes[index]];
                        parent = $(global.dom.stocks + '[stock="' + codes[index] + '"]');
                        cost = parseFloat(parent.attr('cost'));
                        number = parseFloat(parent.attr('number'));
                        amount = parseFloat(parent.attr('amount'));
                        curr = parseFloat(parent.attr('curr')) == 0 ? stockRealtime.curr : parseFloat(parent.attr('curr'));
                        global.currAmount += number * curr;
                        parent.find('.curr').html(curr);
                        parent.find('.profits').html((curr * number - amount).toFixed(2));
                        parent.find('.profitability').html(((curr * number - amount) / amount * 100).toFixed(2));
                        parent.find('.latest-value').html((curr * number).toFixed(2));
                        parent.find('.yclose').html(stockRealtime.yclose);
                        parent.find('.open').html(stockRealtime.open);
                        parent.find('.high').html(stockRealtime.high);
                        parent.find('.low').html(stockRealtime.low);
                    }
                    global.message.show({content: $.format(global.messageTemplate, global.clock, global.totalAmount, global.currAmount, (global.currAmount - global.totalAmount).toFixed(2), stockRealtime[stockRealtime.length - 3], stockRealtime[stockRealtime.length - 2])});
                    if (!refresh) global.clock = setTimeout('getStockInfo(global.stocks.codes)', global.interval);
                }, error: function (err) {
                    delete err.http;
                    global.message.show({content: $.format(global.messageTemplate, global.clock, global.totalAmount, global.currAmount, (global.currAmount - global.totalAmount).toFixed(2), JSON.stringify(err))});
                    if (!refresh) global.clock = setTimeout('getStockInfo(global.stocks.codes)', global.interval);
                }, changed: function (obj) {
                    //window.console.log(JSON.stringify({clock: global.clock, state: obj.state}));
                }});
        }

        function init(stocks) {
            var codes = [];
            var html = '';
            for (var index in stocks) {
                if (!stocks.hasOwnProperty(index)) continue;
                global.totalAmount += stocks[index][2];
                html += $.format(global.stockHtmlTemplate,
                        stocks[index][4], stocks[index][3],
                        stocks[index][1], (stocks[index][2] / stocks[index][1]).toFixed(3), stocks[index][2],
                        stocks[index][5] ? stocks[index][5] : 0, stocks[index][0], index % 2 == 0 ? '' : 'tdeven');
                codes.push(stocks[index][4] + stocks[index][3]);
            }
            stocks.html = html;
            stocks.codes = codes;
        }

        require(['jquery', 'jquery.strings', 'naure.http.xmlhttp', 'naure.message'], function ($, $1, NAURE) {
            global.http = NAURE.HTTP;
            global.message = NAURE.Message;
            $('body').message({overlay: 'left-bottom', multiple: false, title: ''});
            init(global.stocks);
            $(function () {
                $(global.dom.stocksContainer).html(global.stocks.html);
                $(document).on('keyup', function (event) {
                    var ev = document.all ? window.event : event;
                    if (ev.keyCode == 82)  getStockInfo(global.stocks.codes, true);
                    if (ev.keyCode == 72) {
                        'none' == $(global.dom.stocksHead).css('display') ?
                                $(global.dom.stocksHead).css('display', 'table-row') :
                                $(global.dom.stocksHead).css('display', 'none');
                    }
                    if (ev.keyCode == 78) {
                        'none' == $(global.dom.stocksName).css('display') ?
                                $(global.dom.stocksName).css('display', 'table-cell') :
                                $(global.dom.stocksName).css('display', 'none');
                    }
                });

                global.clock = setTimeout('getStockInfo(global.stocks.codes)', 5000);
            });
        });
    </script>
    <style>
        thead tr, tbody tr td.name {
            display: none;
        }

        table tbody tr {
            text-align: right;
        }

        table tbody tr td.name, table tbody tr td.code {
            text-align: center;
        }
    </style>
</head>
<body style="background-color: #ffffff;">
<table id="stocks" rules="rows">
    <colgroup align="right" style="color:#0000FF;"></colgroup>
    <thead>
    <tr>
        <th class="name">证券名称</th>
        <th class="code">证券代码</th>
        <th class="number">证券数量</th>
        <th class="cost">成本价</th>
        <th class="curr">当前价</th>
        <th class="profits">浮动盈亏</th>
        <th class="profitability">盈亏比例(%)</th>
        <th class="amount">成本金额</th>
        <th class="latest-value">最新市值</th>
        <th class="totalcapital">总股本</th>
        <th class="currcapital">流通股本</th>
        <th class="yclose">昨日收盘价</th>
        <th class="open">今日开盘价</th>
        <th class="high">今日最高价</th>
        <th class="low">今日最低价</th>
        <th>竞买价</th>
        <th>竞买价</th>
        <th>竞卖价</th>
        <th>竞卖价</th>
        <th>成交量</th>
        <th>成交额</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
</body>
</html>

var lta = 9026.9304;//流通A股,老数据保留
var lastfive = 30.8432;//过去5个交易日平均每分钟成交量
var flag = 1; //判断标志
var totalcapital = 12773.0893; //总股本
var currcapital = 9026.9304; //流通股本
var curracapital = 0; //流通A股
var currbcapital = 0; //流通B股
var a_code = 'sz000803'; //流通A股代码
var b_code = ''; //流通B股代码
var papercode = 'sz000803'; //当前页面个股代码
var exchangerate = 0; //汇率
var fourQ_mgsy = -0.0250;//最近四个季度每股收益和
var lastyear_mgsy = 0.0333;//前一年每股收益和
var price_5_ago = 8.540;//5日前收盘价格
var price_10_ago = 8.230;//10日前收盘价格
var price_20_ago = 8.110;//20日前收盘价格
var price_60_ago = 7.240;//60日前收盘价格
var price_120_ago = 8.120;//120日前收盘价格
var price_250_ago = 7.220;//250日前收盘价格
var mgjzc = 1.1531;//最近报告的每股净资产
var stock_state = 1;//个股状态（0:无该记录; 1:上市正常交易; 2:未上市; 3:退市）
var trans_flag = 1;//是否显示涨跌停价（1:显示 0:不显示）
var profit = 0.0425;//最近年度净利润
var profit_four = -0.0320;//最近四个季度净利润
var stockType = 'A'; //股票类型  A-A股 B-B股  I-指数
var stockname = '金宇车城'; //股票名称
var corr_hkstock = ''; //相关港股代码
var corr_bdc = ''; //相关债券可转换债
var corr_bde = ''; //相关债券普通企业债

/* BHPsnK7Cm94I1m1LT9oBbUxsAQI/tgPKy65jyFVorJxI+1EIO93Qt424Ixf9wBWPIGXcpKaSbXdJW/qND1DBRMwXtjHUVq5WkIPxRu8dYiHSMhK2rd+G4J8fJTsDMDuXXBGaU/JHe5/+DqKHxzt6MVAozqAWiOvIC008Tg== */